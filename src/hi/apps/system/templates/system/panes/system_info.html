{% extends "config/pages/config_base.html" %}
{% load icons %}
{% load tz %}

{% block config_content %}
{% timezone USER_TIMEZONE %}
<div class="container-fluid">
  <div class="d-flex justify-content-between my-1">
    <div class="h3">System Info</div>
    <div>
      <a role="button" class="btn btn-primary"
         href="#"
         data-async="modal" >
        {% icon "plus" size="sm" css_class="hi-icon-left" %}PLACEHOLDER
      </a>
    </div>
  </div>

  <div>
    PLACEHOLDER
  </div>

  {% if async_diagnostics %}
  <div class="row mt-2">
    <div class="col-sm-3"><strong>Background Tasks:</strong></div>
    <div class="col-sm-9">
      <div class="small">
        <div>Main Thread: {{ async_diagnostics.main_thread.name }}</div>
        <div>Active Threads: {{ async_diagnostics.current_thread.active_count }}</div>

        {% for task_name, task_info in async_diagnostics.background_tasks.items %}
        <div class="mt-1 p-1 border-left border-info">
          <div><strong>{{ task_name }}</strong></div>
          <div>Thread:
            {% if task_info.thread.is_alive %}
            <span class="text-success">
              {% icon "check-circle" size="sm" css_class="mr-1" %}{{ task_info.thread_name }}
            </span>
            {% else %}
            <span class="text-danger">
              {% icon "warning" size="sm" css_class="mr-1" %}Dead
            </span>
            {% endif %}
          </div>
          <div>Event Loop:
            {% if task_info.event_loop.exists and task_info.event_loop.is_running %}
            <span class="text-success">
              {% icon "check-circle" size="sm" css_class="mr-1" %}Running ({{ task_info.event_loop.active_tasks }} active tasks)
            </span>
            {% elif task_info.event_loop.exists %}
            <span class="text-warning">
              {% icon "warning" size="sm" css_class="mr-1" %}Stopped
            </span>
            {% else %}
            <span class="text-danger">
              {% icon "warning" size="sm" css_class="mr-1" %}Dead
            </span>
            {% endif %}
          </div>

          {% if task_info.event_loop.task_details %}
          <div class="mt-1">
            <small>Tasks:</small>
            {% for task_detail in task_info.event_loop.task_details %}
            <div class="ml-2 small">
              - {{ task_detail.coro_name|default:"unknown" }}
              {% if task_detail.done %}(done){% elif task_detail.cancelled %}(cancelled){% else %}(running){% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  
</div>
{% endtimezone %}
{% endblock %}
