{% load icons %}
{% load common_template_helpers %}
{% load attribute_extras %}
{% comment %}
V2 Attribute Card Component
Individual attribute attribute card with value editing and actions
{% endcomment %}

<div class="{{ DIVID.ATTR_V2_ATTRIBUTE_CARD_CLASS }}{% if not attribute_form.instance.pk %} {{ DIVID.ATTR_V2_NEW_ATTRIBUTE_CLASS }}{% endif %}" 
     data-attribute-id="{{ attribute_form.instance.pk }}" 
     data-url-detect="true"
     data-order-index="{{ forloop.counter }}"
     data-value-type="{{ attribute_form.instance.value_type.name|default:'text' }}"
     data-is-secret="{{ attribute_form.instance.value_type.is_secret|yesno:'true,false' }}"
     data-can-delete="{{ attribute_form.instance.attribute_type.can_delete|yesno:'true,false' }}"
     {% if not attribute_form.instance.pk and not attribute_form.is_bound %}style="display: none;"{% endif %}>
  
  <!-- Hidden form fields -->
  {{ attribute_form.id }}
  {% if attribute_form.DELETE %}
    {{ attribute_form.DELETE.as_hidden }}
  {% endif %}
  
  <!-- Attribute Header -->
  <div class="attr-v2-attribute-header">
    <h6 class="{{ DIVID.ATTR_V2_ATTRIBUTE_NAME_CLASS }}">
      {% if attribute_form.instance.pk %}
        {{ attribute_form.instance.name }}
      {% else %}
        {% icon "plus" size="sm" css_class="hi-icon-left" %}Add New
      {% endif %}
    </h6>
    
    <div class="attr-v2-attribute-actions">
      <!-- Reorder Controls (disabled until Issue #80, hidden if allow_reordering is False) -->
      {% if attribute_form.instance.pk and attribute_form.allow_reordering %}
      <button type="button" 
              class="btn btn-sm btn-outline-secondary"
              disabled
              title="Reordering available in future update"
              data-reorder-action="up">
        {% icon "chevron-up" size="sm" %}
      </button>
      <button type="button" 
              class="btn btn-sm btn-outline-secondary"
              disabled
              title="Reordering available in future update"
              data-reorder-action="down">
        {% icon "chevron-down" size="sm" %}
      </button>
      {% endif %}
      
      {% if attribute_form.instance.pk %}
        <a href="{% attr_history_url attr_context attribute_form.instance.pk %}"
           class="btn btn-sm btn-outline-secondary attr-v2-history-link"
           title="View history">
          {% icon "history" size="sm" %}
        </a>
      {% endif %}
      
      {% if attribute_form.instance.pk and attribute_form.instance.attribute_type.can_delete %}
        <button type="button" 
                class="{{ DIVID.ATTR_V2_DELETE_BTN_CLASS }}"
                title="Delete attribute"
                onclick="markAttributeForDeletion('{{ attribute_form.instance.pk }}', '#{{ attr_context.container_html_id }}')" >
          {% icon "delete" size="sm" %}
        </button>
        <button type="button" 
                class="btn btn-sm btn-outline-warning {{ DIVID.ATTR_V2_UNDO_BTN_CLASS }}"
                title="Undo delete"
                onclick="undoAttributeDeletion('{{ attribute_form.instance.pk }}', '#{{ attr_context.container_html_id }}')"
                style="display: none;">
          â†¶ Undo
        </button>
      {% endif %}
    </div>
  </div>
  
  <!-- Attribute Value -->
  <div class="attr-v2-attribute-value">
    {% if attribute_form.instance.pk %}
      <!-- Existing attribute - include hidden name field -->
      <input type="hidden" 
             id="{{ attribute_form.name.id_for_label }}"
             name="{{ attribute_form.name.html_name }}"
             value="{{ attribute_form.instance.name }}" />
    {% else %}
      <!-- New attribute form -->
      <div class="mb-2">
        {{ attribute_form.name.label_tag }}
        {{ attribute_form.name }}
        {% if attribute_form.name.errors %}
          <div class="invalid-feedback d-block">
            {{ attribute_form.name.errors }}
          </div>
        {% endif %}
      </div>
    {% endif %}
    
    {% if attribute_form.instance.pk %}
      <!-- Existing attribute - route by value_type -->
      {% if attribute_form.instance.value_type.is_boolean %}
        {% include "attribute/components/value_types/attribute_value_boolean.html" %}
      {% elif attribute_form.instance.value_type.is_enum %}
        {% include "attribute/components/value_types/attribute_value_enum.html" %}
      {% elif attribute_form.instance.value_type.is_integer %}
        {% include "attribute/components/value_types/attribute_value_integer.html" %}
      {% elif attribute_form.instance.value_type.is_float %}
        {% include "attribute/components/value_types/attribute_value_float.html" %}
      {% elif attribute_form.instance.value_type.is_secret %}
        {% include "attribute/components/value_types/attribute_value_secret.html" %}
      {% else %}
        <!-- TEXT and other types use textarea -->
        <div class="attr-v2-text-value">
          {% include "attribute/components/value_types/attribute_value_text.html" %}
        </div>
      {% endif %}
    {% else %}
      <!-- New attribute - always use textarea (TEXT behavior) -->
      <div class="attr-v2-text-value">
        {% include "attribute/components/value_types/attribute_value_text.html" %}
      </div>
    {% endif %}
    
    <!-- Secret checkbox for new properties -->
    {% if not attribute_form.instance.pk %}
      <div class="attr-v2-secret-checkbox">
        <div class="custom-control custom-checkbox">
          {{ attribute_form.secret }}
          <label class="custom-control-label" for="{{ attribute_form.secret.id_for_label }}">
            Mark as Secret
          </label>
        </div>
      </div>
    {% endif %}
  </div>
  
  <!-- Inline History Target (empty until populated) -->
  {% if attribute_form.instance.pk %}
    <div id="{{ attr_context|history_target_id:attribute_form.instance.pk }}" 
         class="attr-v2-inline-history">
    </div>
  {% endif %}
</div>
