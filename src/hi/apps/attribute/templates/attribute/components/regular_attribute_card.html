{% load icons %}
{% load common_template_helpers %}
{% load attribute_extras %}
{% comment %}
V2 Attribute Card Component
Individual attribute attribute card with value editing and actions
{% endcomment %}

<div class="{{ DIVID.ATTR_V2_ATTRIBUTE_CARD_CLASS }}{% if not attribute_form.instance.pk %} {{ DIVID.ATTR_V2_NEW_ATTRIBUTE_CLASS }}{% endif %}" 
     data-attribute-id="{{ attribute_form.instance.pk }}" 
     data-url-detect="true"
     data-order-index="{{ forloop.counter }}"
     data-value-type="{{ attribute_form.instance.value_type.name|default:'text' }}"
     data-is-secret="{{ attribute_form.instance.value_type.is_secret|yesno:'true,false' }}"
     data-can-delete="{{ attribute_form.instance.attribute_type.can_delete|yesno:'true,false' }}"
     {% if not attribute_form.instance.pk and not attribute_form.is_bound %}style="display: none;"{% endif %}>
  
  <!-- Hidden form fields -->
  {{ attribute_form.id }}
  {% if attribute_form.DELETE %}
    {{ attribute_form.DELETE.as_hidden }}
  {% endif %}
  
  <!-- Attribute Header -->
  <div class="attr-v2-attribute-header">
    <h6 class="{{ DIVID.ATTR_V2_ATTRIBUTE_NAME_CLASS }}">
      {% if attribute_form.instance.pk %}
        {{ attribute_form.instance.name }}
      {% else %}
        {% icon "plus" size="sm" css_class="hi-icon-left" %}Add New
      {% endif %}
    </h6>
    
    <div class="attr-v2-attribute-actions">
      <!-- Reorder Controls (disabled until Issue #80) -->
      {% if attribute_form.instance.pk %}
      <button type="button" 
              class="btn btn-sm btn-outline-secondary"
              disabled
              title="Reordering available in future update"
              data-reorder-action="up">
        {% icon "chevron-up" size="sm" %}
      </button>
      <button type="button" 
              class="btn btn-sm btn-outline-secondary"
              disabled
              title="Reordering available in future update"
              data-reorder-action="down">
        {% icon "chevron-down" size="sm" %}
      </button>
      {% endif %}
      
      {% if attribute_form.instance.pk %}
        <a href="{% attr_history_url attr_context attribute_form.instance.pk %}"
           data-async="#{{ attr_context|history_target_id:attribute_form.instance.pk }}"
           data-stay-in-modal="true"
           class="btn btn-sm btn-outline-secondary"
           title="View history">
          {% icon "history" size="sm" %}
        </a>
      {% endif %}
      
      {% if attribute_form.instance.pk and attribute_form.instance.attribute_type.can_delete %}
        <button type="button" 
                class="{{ DIVID.ATTR_V2_DELETE_BTN_CLASS }}"
                title="Delete attribute"
                onclick="markAttributeForDeletion('{{ attribute_form.instance.pk }}')">
          {% icon "delete" size="sm" %}
        </button>
        <button type="button" 
                class="btn btn-sm btn-outline-warning {{ DIVID.ATTR_V2_UNDO_BTN_CLASS }}"
                title="Undo delete"
                onclick="undoAttributeDeletion('{{ attribute_form.instance.pk }}')"
                style="display: none;">
          â†¶ Undo
        </button>
      {% endif %}
    </div>
  </div>
  
  <!-- Attribute Value -->
  <div class="attr-v2-attribute-value">
    {% if attribute_form.instance.pk %}
      <!-- Existing attribute - include hidden name field -->
      <input type="hidden" 
             id="{{ attribute_form.name.id_for_label }}"
             name="{{ attribute_form.name.html_name }}"
             value="{{ attribute_form.instance.name }}" />
    {% else %}
      <!-- New attribute form -->
      <div class="mb-2">
        {{ attribute_form.name.label_tag }}
        {{ attribute_form.name }}
        {% if attribute_form.name.errors %}
          <div class="invalid-feedback d-block">
            {{ attribute_form.name.errors }}
          </div>
        {% endif %}
      </div>
    {% endif %}
    
    {% if attribute_form.instance.pk and attribute_form.instance.value_type.is_boolean %}
      <!-- Boolean/Switch -->
      <div class="custom-control custom-switch">
        {{ attribute_form.value }}
        <label class="custom-control-label" for="{{ attribute_form.value.id_for_label }}">
          {{ attribute_form.value.label|default:"Toggle value" }}
        </label>
        {% if attribute_form.value.errors %}
          <div class="invalid-feedback d-block">
            {{ attribute_form.value.errors }}
          </div>
        {% endif %}
      </div>
    {% else %}
      <!-- Text/Textarea (default) -->
      <div class="attr-v2-text-value">
        {% if attribute_form.instance.pk and attribute_form.instance.value_type.is_secret %}
          <div class="attr-v2-secret-field">
            <div class="attr-v2-secret-input-wrapper">
              <!-- Secret field as password input -->
              <input type="password" 
                     id="{{ attribute_form.value.id_for_label }}"
                     name="{{ attribute_form.value.html_name }}"
                     class="form-control attr-v2-secret-input"
                     value="{{ attribute_form.value.value|default_if_none:'' }}"
                     readonly="readonly"
                     {% if attribute_form.instance and not attribute_form.instance.is_editable %}disabled="true"{% endif %} />
              {% if attribute_form.value.errors %}
                <div class="invalid-feedback d-block">
                  {{ attribute_form.value.errors }}
                </div>
              {% endif %}
              <button type="button" 
                      class="btn btn-sm btn-outline-secondary attr-v2-secret-toggle"
                      onclick="attrV2.toggleSecretField(this)"
                      title="Show value">
                <span class="attr-v2-icon-show">{% icon "eye" size="sm" %}</span>
                <span class="attr-v2-icon-hide" style="display: none;">{% icon "eye-off" size="sm" %}</span>
              </button>
            </div>
          </div>
        {% else %}
          <!-- Hidden field pattern for data integrity -->
          {% with value_text=attribute_form.value.value|default_if_none:'' %}
          {% with line_count=value_text|linecount %}
          {% with display_rows=line_count|min_value:4 %}
          {% with overflows=line_count|add:"-4" %}
          <div class="attr-v2-text-value-wrapper" data-overflow="{% if overflows > 0 %}true{% else %}false{% endif %}" data-line-count="{{ line_count }}">
            
            <!-- Real form field - contains actual data, never manipulated during editing -->
            <input type="hidden" 
                   name="{{ attribute_form.value.html_name }}"
                   id="hidden-{{ attribute_form.value.id_for_label }}"
                   value="{{ attribute_form.value.value|default_if_none:'' }}">
            
            <!-- Display field - for UI only (no name = not submitted) -->
            <textarea rows="{{ display_rows }}" 
                      id="{{ attribute_form.value.id_for_label }}"
                      class="form-control attr-v2-textarea display-field"
                      data-overflow="{% if overflows > 0 %}true{% else %}false{% endif %}"
                      data-hidden-field="hidden-{{ attribute_form.value.id_for_label }}"
                      {% if attribute_form.instance and not attribute_form.instance.is_editable %}disabled="true"{% endif %}
                      data-original-value="{{ attribute_form.value.value|default_if_none:'' }}">{{ attribute_form.value.value|default_if_none:'' }}</textarea>
            {% if attribute_form.value.errors %}
              <div class="invalid-feedback d-block">
                {{ attribute_form.value.errors }}
              </div>
            {% endif %}
            {% if overflows > 0 %}
            <div class="attr-v2-expand-controls" style="display: block;">
              <button type="button" class="btn btn-sm btn-link" onclick="attrV2.toggleExpandedView(this)">
                <span class="show-more-text">Show more...</span>
                <span class="show-less-text" style="display: none;">Show less</span>
              </button>
            </div>
            {% endif %}
          </div>
          {% endwith %}
          {% endwith %}
          {% endwith %}
          {% endwith %}
        {% endif %}
      </div>
    {% endif %}
    
    <!-- Secret checkbox for new properties -->
    {% if not attribute_form.instance.pk %}
      <div class="attr-v2-secret-checkbox">
        <div class="custom-control custom-checkbox">
          {{ attribute_form.secret }}
          <label class="custom-control-label" for="{{ attribute_form.secret.id_for_label }}">
            Mark as Secret
          </label>
        </div>
      </div>
    {% endif %}
  </div>
  
  <!-- Inline History Target (empty until populated) -->
  {% if attribute_form.instance.pk %}
    <div id="{{ attr_context|history_target_id:attribute_form.instance.pk }}" 
         class="attr-v2-inline-history">
    </div>
  {% endif %}
</div>
