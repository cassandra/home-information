{% load video_tags %}

<div class="entity-video-sensor-history">
    <!-- Header with entity name and mode switch -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>{{ entity.name }} - Sensor Response History</h5>
        <a href="{% url 'console_entity_video_stream' entity.id %}" 
           class="btn btn-sm btn-outline-primary"
           data-async="#main-content">
            Back to Current Stream
        </a>
    </div>

    <!-- Main content area split into timeline and video -->
    <div class="row">
        <!-- Timeline sidebar -->
        <div class="col-md-3">
            <div class="timeline-container">
                <h6>Activity Timeline</h6>
                
                {% for group in timeline_groups %}
                <div class="timeline-group mb-3">
                    <div class="timeline-group-label font-weight-bold">
                        {{ group.label }}
                    </div>
                    
                    <div class="timeline-items">
                        {% for response in group.items %}
                        <div class="timeline-item {% if response.detail_attrs.sensor_history_id == current_sensor_response.detail_attrs.sensor_history_id %}active{% endif %}">
                            <a href="{% url 'console_entity_video_sensor_history_detail' entity.id sensor.id response.detail_attrs.sensor_history_id %}"
                               data-async="#main-content"
                               class="text-decoration-none">
                                <div class="d-flex justify-content-between">
                                    <span class="time">{{ response.timestamp|date:"g:i A" }}</span>
                                    <span class="badge {% if response.value == 'active' %}badge-warning{% else %}badge-secondary{% endif %}">
                                        {{ response.value }}
                                    </span>
                                </div>
                                {% if response.detail_attrs.sensor_history_id == current_sensor_response.detail_attrs.sensor_history_id %}
                                <small class="text-muted">→ Currently viewing</small>
                                {% endif %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No sensor responses available</p>
                {% endfor %}
            </div>
        </div>

        <!-- Video and details area -->
        <div class="col-md-9">
            {% if current_sensor_response %}
            <div class="video-detail-container">
                <!-- Response header -->
                <div class="response-header mb-3">
                    <h6>{{ current_sensor_response.detail_attrs.details }}</h6>
                    <div class="text-muted">
                        {{ current_sensor_response.timestamp|date:"F j, Y g:i A" }}
                    </div>
                </div>

                <!-- Video display area -->
                <div class="video-container mb-3">
                    {% sensor_response_video_stream current_sensor_response as video_url %}
                    {% if video_url %}
                    <img class="img-fluid" src="{{ video_url }}" alt="Sensor Response Video Stream">
                    {% else %}
                    <!-- Fallback for Phase 1 demonstration -->
                    <div class="bg-secondary text-white d-flex align-items-center justify-content-center" 
                         style="height: 400px;">
                        <div class="text-center">
                            <h4>Video Stream Placeholder</h4>
                            <p>Sensor History ID: {{ current_sensor_response.detail_attrs.sensor_history_id }}</p>
                            <p>Duration: {{ current_sensor_response.detail_attrs.duration_seconds }} seconds</p>
                            <small>Phase 2 will load SensorHistory record and convert to SensorResponse</small>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Response details -->
                <div class="response-details">
                    <div class="row">
                        <div class="col-sm-6">
                            <strong>Sensor:</strong> {{ sensor.name }}<br>
                            <strong>State Type:</strong> {{ sensor.entity_state.entity_state_type }}<br>
                            <strong>Value:</strong> {{ current_sensor_response.value }}
                        </div>
                        <div class="col-sm-6">
                            <strong>Duration:</strong> {{ current_sensor_response.detail_attrs.duration_seconds }} seconds<br>
                            <strong>Entity Type:</strong> {{ entity.entity_type }}<br>
                            <strong>Has Video:</strong> {{ current_sensor_response.has_video_stream|yesno:"Yes,No" }}
                        </div>
                    </div>
                </div>

                <!-- Navigation buttons -->
                <div class="navigation-buttons mt-3 d-flex justify-content-between">
                    {% if prev_sensor_response %}
                    <a href="{% url 'console_entity_video_sensor_history_detail' entity.id sensor.id prev_sensor_response.detail_attrs.sensor_history_id %}"
                       class="btn btn-outline-secondary"
                       data-async="#main-content">
                        ← Previous Response
                    </a>
                    {% else %}
                    <button class="btn btn-outline-secondary" disabled>← Previous Response</button>
                    {% endif %}

                    {% if next_sensor_response %}
                    <a href="{% url 'console_entity_video_sensor_history_detail' entity.id sensor.id next_sensor_response.detail_attrs.sensor_history_id %}"
                       class="btn btn-outline-secondary"
                       data-async="#main-content">
                        Next Response →
                    </a>
                    {% else %}
                    <button class="btn btn-outline-secondary" disabled>Next Response →</button>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                No sensor responses available for this sensor.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Basic styling for the sensor history view */
.timeline-container {
    max-height: 600px;
    overflow-y: auto;
}

.timeline-item {
    padding: 8px;
    margin-bottom: 4px;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.timeline-item:hover {
    background-color: #f8f9fa;
}

.timeline-item.active {
    background-color: #e9ecef;
    border-left-color: #007bff;
}

.timeline-group-label {
    color: #495057;
    padding: 4px 0;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 8px;
}

.video-container {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
}

.event-details {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
}
</style>