{% extends "modals/action_done.html" %}
{% load humanize %}
{% load tz %}

{% block title_text %}
{{ alert.title }}
{% endblock %}

{% block body %}
{% timezone USER_TIMEZONE %}

<!-- Alert Summary Header -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card border-0 bg-light">
      <div class="card-body py-2">
        <div class="row">
          <div class="col-6">
            <small class="text-muted">Alert Level</small><br>
            <span class="badge badge-{% if alert.alarm_level.priority <= 2 %}danger{% elif alert.alarm_level.priority <= 4 %}warning{% else %}secondary{% endif %}">
              {{ alert.alarm_level.label }}
            </span>
          </div>
          <div class="col-6">
            <small class="text-muted">Alert Source</small><br>
            <strong>{{ alert.alarm_source.label }}</strong>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-6">
            <small class="text-muted">Alert Type</small><br>
            <strong>{{ alert.alarm_type }}</strong>
          </div>
          <div class="col-6">
            <small class="text-muted">Started</small><br>
            <strong>{{ alert.start_datetime|localtime|naturaltime }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Check ALL alarms for visual content -->
{% for alarm in alert.alarm_list %}
  {% for source_details in alarm.source_details_list %}
    {% if source_details.image_url %}
<!-- Visual Content (Prominent Display) -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-camera mr-2"></i>Visual Content
        </h6>
      </div>
      <div class="card-body p-2">
        <img class="img-fluid" src="{{ source_details.image_url }}" alt="{{ alarm.title }}">
        {% if alarm != alert.alarm_list.0 %}
          <small class="text-muted d-block mt-1">From: {{ alarm.timestamp|localtime|date:"M j, Y H:i" }}</small>
        {% endif %}
      </div>
    </div>
  </div>
</div>
      {% break %}
    {% endif %}
  {% endfor %}
  {% if source_details.image_url %}{% break %}{% endif %}
{% endfor %}

<!-- Recent Alarm Details -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          Recent Activity
          {% if alert.alarm_count > 1 %}
            <span class="badge badge-secondary ml-2">{{ alert.alarm_count }} alarm{{ alert.alarm_count|pluralize }}</span>
          {% endif %}
        </h6>
      </div>
      <div class="card-body">
        {% with alarm=alert.alarm_list.0 %}
          <div class="mb-2">
            <small class="text-muted">{{ alarm.timestamp|localtime|date:"M j, Y H:i" }}</small>
          </div>
          {% include "alert/panes/alarm_details.html" %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>

<!-- Additional Alarms (Collapsible) -->
{% if alert.alarm_count > 1 %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <a class="text-decoration-none" data-toggle="collapse" href="#additionalAlarms" 
             role="button" aria-expanded="false" aria-controls="additionalAlarms">
            <i class="fas fa-chevron-right mr-2"></i>Previous Alarms ({{ alert.alarm_count|add:"-1" }})
          </a>
        </h6>
      </div>
      <div class="collapse" id="additionalAlarms">
        <div class="card-body">
          {% for alarm in alert.alarm_list %}
            {% if not forloop.first %}
              <div class="border-bottom mb-3 pb-3">
                <h6>Alarm {{ forloop.counter }}: {{ alarm.title }}</h6>
                <small class="text-muted">{{ alarm.timestamp|localtime|date:"M j, Y H:i" }}</small>
                {% include "alert/panes/alarm_details.html" %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endtimezone %}
{% endblock %}
