{% extends "modals/action_done.html" %}
{% load icons %}
{% load tz %}

{% block modal_dialog_class %}hi-modal-dialog-800{% endblock %}

{% block title_text %}
{% icon "shield" size="sm" css_class="mr-2" %}
{{ monitor_label }} Health Status
{% endblock %}

{% block body %}
{% timezone USER_TIMEZONE %}

<div class="container-fluid px-0">
    <!-- Overall Monitor Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center mb-3">
                <span class="badge monitor-status-badge {{ health_status.status_badge_class }} mr-3">
                    {% icon health_status.status_icon size="sm" css_class="mr-2" %}
                    {{ health_status.status_display }}
                </span>
            </div>

            <!-- Monitor Heartbeat -->
            {% if health_status.monitor_heartbeat %}
            <div class="row">
                <div class="col-sm-3"><strong>Monitor Status:</strong></div>
                <div class="col-sm-9">
                    <span class="heartbeat-indicator {{ health_status.heartbeat_css_class }}"></span>
                    <span class="{{ health_status.heartbeat_text_class }}">{{ health_status.heartbeat_status_text }}</span>
                    <small class="text-muted-custom">
                        (last seen {{ health_status.monitor_heartbeat|localtime|date:"H:i:s" }})
                    </small>
                </div>
            </div>
            {% endif %}

            <div class="row mt-2">
                <div class="col-sm-3"><strong>Last Check:</strong></div>
                <div class="col-sm-9">{{ health_status.last_check|localtime|date:"M j, Y H:i:s" }}</div>
            </div>

            {% if health_status.error_message %}
            <div class="row mt-2">
                <div class="col-sm-3"><strong>Error Details:</strong></div>
                <div class="col-sm-9">
                    <div class="alert {% if health_status.requires_attention %}alert-danger{% else %}alert-warning{% endif %} p-2">
                        {{ health_status.error_message }}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if health_status.error_count > 1 %}
            <div class="row mt-2">
                <div class="col-sm-3"><strong>Error Count:</strong></div>
                <div class="col-sm-9">{{ health_status.error_count }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if health_status.has_api_sources %}
    <!-- API Sources Section -->
    <div class="row">
        <div class="col-12">
            <h6 class="mb-3">
                {% icon "plug" size="sm" css_class="mr-2" %}
                API Sources
            </h6>

            {% for api_source in health_status.api_sources %}
            <div class="api-source-section {{ api_source.border_color_class }} mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">{{ api_source.source_name }}</h6>
                    <span class="badge {{ api_source.status_badge_class }}">
                        {% icon api_source.status_icon size="sm" css_class="mr-1" %}{{ api_source.status.label }}
                    </span>
                </div>

                {% if api_source.last_success %}
                <div class="row">
                    <div class="col-sm-3"><strong>Last Success:</strong></div>
                    <div class="col-sm-9">{{ api_source.last_success|localtime|date:"H:i:s" }}</div>
                </div>
                {% endif %}

                <div class="api-metrics-grid mt-2">
                    <div class="metric-item {{ api_source.status_css_class }}">
                        <div class="small text-muted-custom">Total Calls</div>
                        <div class="metric-value">{{ api_source.total_calls|floatformat:0 }}</div>
                    </div>
                    <div class="metric-item {{ api_source.status_css_class }}">
                        <div class="small text-muted-custom">Success Rate</div>
                        <div class="metric-value">{{ api_source.success_rate_percentage|floatformat:1 }}%</div>
                    </div>
                    {% if api_source.last_response_time %}
                    <div class="metric-item {{ api_source.status_css_class }}">
                        <div class="small text-muted-custom">Last Response</div>
                        <div class="metric-value">{{ api_source.last_response_time|floatformat:2 }}s</div>
                    </div>
                    {% elif api_source.average_response_time %}
                    <div class="metric-item {{ api_source.status_css_class }}">
                        <div class="small text-muted-custom">Avg Response</div>
                        <div class="metric-value">{{ api_source.average_response_time|floatformat:2 }}s</div>
                    </div>
                    {% else %}
                    <div class="metric-item {{ api_source.status_css_class }}">
                        <div class="small text-muted-custom">Response Time</div>
                        <div class="metric-value">timeout</div>
                    </div>
                    {% endif %}
                    {% if api_source.total_failures > 0 or api_source.consecutive_failures > 0 %}
                    <div class="metric-item {{ api_source.status_css_class }}">
                        <div class="small text-muted-custom">
                            {% if api_source.consecutive_failures > 0 %}Consecutive Failures{% else %}Total Failures{% endif %}
                        </div>
                        <div class="metric-value">
                            {% if api_source.consecutive_failures > 0 %}{{ api_source.consecutive_failures }}{% else %}{{ api_source.total_failures }}{% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Status Summary Alert -->
    <div class="row">
        <div class="col-12">
            <div class="alert {{ health_status.status_alert_class }}">
                <p class="mb-0">
                    {% icon health_status.status_icon size="sm" css_class="mr-2" %}
                    {{ health_status.status_summary_message }}
                </p>
            </div>
        </div>
    </div>
</div>

{% endtimezone %}
{% endblock %}