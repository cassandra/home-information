{% extends "modals/action_done.html" %}
{% load icons %}
{% load tz %}

{% block title_text %}
{{ integration_data.label }} Health Status
{% endblock %}

{% block body %}
{% timezone USER_TIMEZONE %}

<div class="mb-3">
  <div class="d-flex align-items-center mb-2">
    <span class="badge badge-lg {% if health_status.is_healthy %}badge-success{% elif health_status.is_critical %}badge-danger{% else %}badge-warning{% endif %} mr-3">
      {% if health_status.is_healthy %}
        {% icon "check-circle" size="lg" css_class="mr-1" %}{{ health_status.status_display }}
      {% elif health_status.is_critical %}
        {% icon "warning" size="lg" css_class="mr-1" %}{{ health_status.status_display }}
      {% else %}
        {% icon "info-circle" size="lg" css_class="mr-1" %}{{ health_status.status_display }}
      {% endif %}
    </span>
  </div>
</div>

<div class="row">
  <div class="col-sm-3"><strong>Last Check:</strong></div>
  <div class="col-sm-9">{{ health_status.last_check|localtime|date:"M j, Y H:i:s" }}</div>
</div>

{% if health_status.error_message %}
<div class="row mt-2">
  <div class="col-sm-3"><strong>Error Details:</strong></div>
  <div class="col-sm-9">
    <div class="alert alert-{% if health_status.is_critical %}danger{% else %}warning{% endif %} p-2">
      {{ health_status.error_message }}
    </div>
  </div>
</div>
{% endif %}

{% if health_status.error_count > 1 %}
<div class="row mt-2">
  <div class="col-sm-3"><strong>Error Count:</strong></div>
  <div class="col-sm-9">{{ health_status.error_count }}</div>
</div>
{% endif %}

{% if health_status.monitor_heartbeat %}
<div class="row mt-3">
  <div class="col-sm-12">
    <h6 class="mb-2">Enhanced Monitoring</h6>
  </div>
  <div class="col-sm-3"><strong>Monitor Status:</strong></div>
  <div class="col-sm-9">
    {% if health_status.monitor_heartbeat_age_seconds < 30 %}
      <span class="text-success">
        {% icon "check-circle" size="sm" css_class="mr-1" %}Active
      </span>
      (last seen {{ health_status.monitor_heartbeat|localtime|date:"H:i:s" }})
    {% else %}
      <span class="text-warning">
        {% icon "warning" size="sm" css_class="mr-1" %}Stale
      </span>
      ({{ health_status.monitor_heartbeat_age_seconds|floatformat:0 }} seconds ago)
    {% endif %}
  </div>
</div>

{% if health_status.last_api_success %}
<div class="row mt-2">
  <div class="col-sm-3"><strong>Last API Success:</strong></div>
  <div class="col-sm-9">{{ health_status.last_api_success|localtime|date:"H:i:s" }}</div>
</div>
{% endif %}

{% if health_status.api_metrics %}
<div class="row mt-2">
  <div class="col-sm-3"><strong>API Metrics:</strong></div>
  <div class="col-sm-9">
    <div class="small">
      <div>Total calls: {{ health_status.api_metrics.total_calls }}</div>
      {% if health_status.api_metrics.total_failures > 0 %}
      <div class="text-warning">
        {% icon "warning" size="sm" css_class="mr-1" %}
        Failures: {{ health_status.api_metrics.total_failures }}
        ({{ health_status.api_metrics.consecutive_failures }} consecutive)
      </div>
      {% endif %}
      {% if health_status.api_metrics.last_response_time %}
      <div>
        Last response time: {{ health_status.api_metrics.last_response_time|floatformat:2 }}s
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{% if health_status.async_diagnostics %}
<div class="row mt-2">
  <div class="col-sm-3"><strong>Background Tasks:</strong></div>
  <div class="col-sm-9">
    <div class="small">
      <div>Main Thread: {{ health_status.async_diagnostics.main_thread.name }}</div>
      <div>Active Threads: {{ health_status.async_diagnostics.current_thread.active_count }}</div>

      {% for task_name, task_info in health_status.async_diagnostics.background_tasks.items %}
      <div class="mt-1 p-1 border-left border-info">
        <div><strong>{{ task_name }}</strong></div>
        <div>Thread:
          {% if task_info.thread.is_alive %}
            <span class="text-success">
              {% icon "check-circle" size="sm" css_class="mr-1" %}{{ task_info.thread_name }}
            </span>
          {% else %}
            <span class="text-danger">
              {% icon "warning" size="sm" css_class="mr-1" %}Dead
            </span>
          {% endif %}
        </div>
        <div>Event Loop:
          {% if task_info.event_loop.exists and task_info.event_loop.is_running %}
            <span class="text-success">
              {% icon "check-circle" size="sm" css_class="mr-1" %}Running ({{ task_info.event_loop.active_tasks }} active tasks)
            </span>
          {% elif task_info.event_loop.exists %}
            <span class="text-warning">
              {% icon "warning" size="sm" css_class="mr-1" %}Stopped
            </span>
          {% else %}
            <span class="text-danger">
              {% icon "warning" size="sm" css_class="mr-1" %}Dead
            </span>
          {% endif %}
        </div>

        {% if task_info.event_loop.task_details %}
        <div class="mt-1">
          <small>Tasks:</small>
          {% for task_detail in task_info.event_loop.task_details %}
          <div class="ml-2 small">
            - {{ task_detail.coro_name|default:"unknown" }}
            {% if task_detail.done %}(done){% elif task_detail.cancelled %}(cancelled){% else %}(running){% endif %}
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endif %}

{% if health_status.is_healthy %}
<div class="alert alert-success mt-3">
  <p class="mb-0">
    {% icon "check-circle" size="sm" css_class="mr-2" %}
    This integration is operating normally. All configuration settings are valid and the connection to the external service is working properly.
  </p>
</div>
{% elif health_status.is_critical %}
<div class="alert alert-danger mt-3">
  <p class="mb-0">
    {% icon "warning" size="sm" css_class="mr-2" %}
    This integration requires immediate attention. Please check the configuration settings and ensure the external service is accessible.
  </p>
</div>
{% else %}
<div class="alert alert-warning mt-3">
  <p class="mb-0">
    {% icon "info-circle" size="sm" css_class="mr-2" %}
    This integration has encountered temporary issues. The problem may resolve automatically, but monitoring is recommended.
  </p>
</div>
{% endif %}

{% endtimezone %}
{% endblock %}
